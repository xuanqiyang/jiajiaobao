!function(e,a){function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function s(s,t){function n(a){var i=e("#"+a.id);delete I[a.id],d(),i.off().find(".file-panel").off().end().remove()}function o(a){var i=e('<li id="'+a.id+'"><p class="title">'+a.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),s=e('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(i),t=i.find("p.progress span"),n=i.find("p.imgWrap"),o=e('<p class="error"></p>'),d=function(e){switch(e){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}o.text(text).appendTo(i)};"invalid"===a.getStatus()?d(a.statusText):(n.text("预览中"),B.makeThumb(a,function(a,i){var s;a?n.text("不能预览"):T?(s=e('<img src="'+i+'">'),n.empty().append(s)):e.ajax("../../server/preview.php",{method:"POST",data:i,dataType:"json"}).done(function(a){a.result?(s=e('<img src="'+a.result+'">'),n.empty().append(s)):n.text("预览出错")})},U,C),I[a.id]=[a.size,0],a.rotation=0),a.on("statuschange",function(e,n){"progress"===n?t.hide().width(0):"queued"===n&&(i.off("mouseenter mouseleave"),s.remove()),"error"===e||"invalid"===e?(console.log(a.statusText),d(a.statusText),i.append(s),i.on("mouseenter",l),i.on("mouseleave",r),s.on("click","span",p),I[a.id][1]=1):"interrupt"===e?(d("interrupt"),i.append(s),i.on("mouseenter",l),i.on("mouseleave",r),s.on("click","span",p)):"queued"===e?(o.remove(),t.css("display","block"),I[a.id][1]=0):"progress"===e?(o.remove(),t.css("display","block")):"complete"===e&&(t.hide().width(0),i.append('<span class="success"></span>')),i.removeClass("state-"+n).addClass("state-"+e)});var l=function(){s.stop().animate({height:30})},r=function(){s.stop().animate({height:0})},p=function(){var i;switch(e(this).index()){case 0:return void B.removeFile(a);case 1:a.rotation+=90;break;case 2:a.rotation-=90}z?(i="rotate("+a.rotation+"deg)",n.css({"-webkit-transform":i,"-mos-transform":i,"-o-transform":i,transform:i})):n.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(a.rotation/90%4+4)%4+")")};i.on("mouseenter",l),i.on("mouseleave",r),s.on("click","span",p),i.appendTo(g)}function d(){var a,i=0,s=0,t=x.children();e.each(I,function(e,a){s+=a[0],i+=a[0]*a[1]}),a=s?i/s:0,t.eq(0).text(Math.round(100*a)+"%"),t.eq(1).css("width",Math.round(100*a)+"%"),l()}function l(){var e,a="";"ready"===F?a="选中"+y+"张图片，共"+WebUploader.formatSize(S)+"。":"confirm"===F?(e=B.getStats()).uploadFailNum&&(a="已成功上传"+e.successNum+"张照片至XX相册，"+e.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'):(e=B.getStats(),a="共"+y+"张（"+WebUploader.formatSize(S)+"），已上传"+e.successNum+"张",e.uploadFailNum&&(a+="，失败"+e.uploadFailNum+"张")),w.html(a)}function r(a){var i;if(a!==F){switch(O.removeClass("state-"+F),O.addClass("state-"+a),F=a){case"pedding":k.removeClass("element-invisible"),g.hide(),b.addClass("element-invisible"),B.refresh();break;case"ready":k.addClass("element-invisible"),e(".pickerid").removeClass("element-invisible"),g.show(),b.removeClass("element-invisible"),B.refresh();break;case"uploading":e(".pickerid").addClass("element-invisible"),x.show(),O.text("暂停上传");break;case"paused":x.show(),O.text("继续上传");break;case"confirm":if(x.hide(),e(".pickerid").removeClass("element-invisible"),O.text("开始上传"),(i=B.getStats()).successNum&&!i.uploadFailNum)return void r("finish");break;case"finish":(i=B.getStats()).successNum?alert("上传成功"):(F="done",location.reload())}l()}}if(!WebUploader.Uploader.support()){var p="上传控件不支持您的浏览器！请尝试升级flash版本或者使用Chrome引擎的浏览器。<a target='_blank' href='http://se.360.cn'>下载页面</a>";return a.console&&a.console.log(p),void e(s).text(p)}var c={auto:!0,hiddenInputId:"uploadifyHiddenInputId",onAllComplete:function(e){},onComplete:function(e){},innerOptions:{},fileNumLimit:void 0,fileSizeLimit:void 0,fileSingleSizeLimit:void 0,PostbackHold:!1},u=e.extend(c,t),f=e("#"+u.hiddenInputId),m=e(s),h="",v=m,g=e('<ul class="filelist"></ul>').appendTo(v.find(".queueList")),b=v.find(".statusBar"),w=b.find(".info"),k=v.find(".placeholder"),x=b.find(".progress").hide(),y=0,S=0,A=a.devicePixelRatio||1,U=110*A,C=110*A,F="pedding",I={},T=function(){var e=new Image,a=!0;return e.onload=e.onerror=function(){1==this.width&&1==this.height||(a=!1)},e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a}(),N=function(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(a){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(a){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)}(),z=function(){var e=document.createElement("p").style,a="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,a}();if(WebUploader.Uploader.support("flash")||!WebUploader.browser.ie)if(WebUploader.Uploader.support()){h="undefined"!=typeof guidGenerator36?guidGenerator36():(65536*(1+Math.random())|0).toString(16).substring(1);var W="";u.auto?W+='<div class="statusBar"><div class="progress"><span class="text">0%</span><span class="percentage"></span></div><div class="info"></div><div class="btns"><div class="'+h+'">选择文件</div>':W+='<div class="statusBar"><div class="progress"><span class="text">0%</span><span class="percentage"></span></div><div class="info"></div><div class="btns"><div class="'+h+'">选择文件</div><div class="uploadBtn">开始上传</div>',W+='<div style="display:none" class="UploadhiddenInput" >                         </div>',W+="</div>",m.append(W);var L=m.find(".uploader-list"),O=m.find(".uploadBtn"),F="pending",j=m.find(".UploadhiddenInput"),P={fileList:[]},q=e.extend({swf:"Uploader.swf",server:"http://webuploader.duapp.com/server/fileupload.php",pick:"."+h,resize:!1,fileNumLimit:u.fileNumLimit,fileSizeLimit:u.fileSizeLimit,fileSingleSizeLimit:u.fileSingleSizeLimit,accept:u.accept},u.innerOptions),B=WebUploader.create(q),D=f.val();D&&u.PostbackHold&&(P=JSON.parse(D),e.each(P.fileList,function(e,a){var s=i();a.queueId=s,L.append('<div id="'+s+'" class="item"><div class="info">'+a.name+'</div><div class="state">已上传</div><div class="del"></div></div>')}),f.val(JSON.stringify(P))),B.on("ready",function(){a.uploader=B}),O.on("click",function(){if(e(this).hasClass("disabled"))return!1;"ready"===F?B.upload():"paused"===F?B.upload():"uploading"===F&&B.stop()}),w.on("click",".retry",function(){B.retry()}),w.on("click",".ignore",function(){B.removeFile(file)}),O.addClass("state-"+F),d(),B.on("dialogOpen",function(){console.log("here")}),B.onUploadProgress=function(a,i){e("#"+a.id).find(".progress span").css("width",100*i+"%"),I[a.id][1]=i,d()},B.onFileQueued=function(e){y++,S+=e.size,1===y&&(k.addClass("element-invisible"),b.show()),o(e),r("ready"),d()},B.onFileDequeued=function(e){y--,S-=e.size,y||r("pedding"),n(e),d()},B.on("all",function(e){switch(e){case"uploadFinished":r("confirm");break;case"startUpload":r("uploading");break;case"stopUpload":r("paused")}}),B.onError=function(e){alert("Eroor: "+e)},B.on("uploadProgress",function(a,i){var t=m.find("#"+e(s)[0].id+a.id),n=t.find(".progress .bar");n.length||(n=e('<span class="progress"><span  class="percentage"><span class="text"></span><span class="bar" role="progressbar" style="width: 0%"></span></span></span>').appendTo(t).find(".bar")),t.find("span.webuploadstate").html("上传中"),t.find(".text").text(Math.round(100*i)+"%"),n.css("width",100*i+"%")}),B.on("uploadSuccess",function(a,i){"error"==i.state?m.find("#"+e(s)[0].id+a.id).find("span.webuploadstate").html(i.message):(m.find("#"+e(s)[0].id+a.id).find("span.webuploadstate").html("已上传"),j.append('<input type="text" id="hiddenInput'+e(s)[0].id+a.id+'" class="hiddenInput" value="'+i.message+'" />'))}),B.on("uploadError",function(a){m.find("#"+e(s)[0].id+a.id).find("span.webuploadstate").html("上传出错")}),B.on("uploadComplete",function(a){m.find("#"+e(s)[0].id+a.id).find(".progress").fadeOut()}),B.on("all",function(e){"startUpload"===e?F="uploading":"stopUpload"===e?F="paused":"uploadFinished"===e&&(F="done"),"uploading"===F?O.text("暂停上传"):O.text("开始上传")}),B.on("fileDequeued",function(a){var i=e("#hiddenInput"+e(s)[0].id+a.id).val();null!=i&&e.post(q.deleteServer,{fullName:i},function(e){alert(e.message)}),e("#"+e(s)[0].id+a.id).remove(),e("#hiddenInput"+e(s)[0].id+a.id).remove()}),L.on("click",".webuploadDelbtn",function(){alert("hi");var a=(a=e(this).parent().attr("id")).replace(e(s)[0].id,""),i=B.getFile(a);B.removeFile(i)})}else alert("Web Uploader 不支持您的浏览器！");else N?function(e){a.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete a.expressinstallcallback};var i="./expressInstall.swf",s='<object type="application/x-shockwave-flash" data="'+i+'" ';WebUploader.browser.ie&&(s+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),s+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+i+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',e.html(s)}(v):v.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}var t=""===a.applicationPath?"":a.applicationPath||"../..";e.fn.GetFilesAddress=function(a){var i=[];return e(this).find(".UploadhiddenInput").find(".hiddenInput").each(function(){i.push(e(this).val())}),i},e.fn.powerWebUpload=function(a){var i=this;if("undefined"==typeof WebUploader){var n=t+"/js/webuploader.css";e("<link>").attr({rel:"stylesheet",type:"text/css",href:n}).appendTo("head");var o=t+"/js/webuploader.js";e.getScript(o).done(function(){s(i,a)}).fail(function(){alert("请检查webuploader的路径是否正确!")})}else s(i,a)}}(jQuery,window);