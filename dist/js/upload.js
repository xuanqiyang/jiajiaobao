$(function(){function e(e){var a=$('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),t=$('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(a),i=a.find("p.progress span"),s=a.find("p.imgWrap"),o=$('<p class="error"></p>'),l=function(e){switch(e){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}o.text(text).appendTo(a)};"invalid"===e.getStatus()?l(e.statusText):(s.text("预览中"),n.makeThumb(e,function(e,a){var t;e?s.text("不能预览"):k?(t=$('<img src="'+a+'">'),s.empty().append(t)):$.ajax("http://localhost:8080/jiajiaobao/server/preview.php",{method:"POST",data:a,dataType:"json"}).done(function(e){e.result?(t=$('<img src="'+e.result+'">'),s.empty().append(t)):s.text("预览出错")})},v,b),w[e.id]=[e.size,0],e.rotation=0),e.on("statuschange",function(s,n){"progress"===n?i.hide().width(0):"queued"===n&&(a.off("mouseenter mouseleave"),t.remove()),"error"===s||"invalid"===s?(console.log(e.statusText),l(e.statusText),w[e.id][1]=1):"interrupt"===s?l("interrupt"):"queued"===s?(o.remove(),i.css("display","block"),w[e.id][1]=0):"progress"===s?(o.remove(),i.css("display","block")):"complete"===s&&(i.hide().width(0),a.append('<span class="success"></span>')),a.removeClass("state-"+n).addClass("state-"+s)}),a.on("mouseenter",function(){t.stop().animate({height:30})}),a.on("mouseleave",function(){t.stop().animate({height:0})}),t.on("click","span",function(){var a;switch($(this).index()){case 0:return void n.removeFile(e);case 1:e.rotation+=90;break;case 2:e.rotation-=90}y?(a="rotate("+e.rotation+"deg)",s.css({"-webkit-transform":a,"-mos-transform":a,"-o-transform":a,transform:a})):s.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),a.appendTo(r)}function a(e){var a=$("#"+e.id);delete w[e.id],t(),a.off().find(".file-panel").off().end().remove()}function t(){var e,a=0,t=0,s=u.children();$.each(w,function(e,i){t+=i[0],a+=i[0]*i[1]}),e=t?a/t:0,s.eq(0).text(Math.round(100*e)+"%"),s.eq(1).css("width",Math.round(100*e)+"%"),i()}function i(){var e,a="";"ready"===g?a="选中"+f+"张图片，共"+WebUploader.formatSize(m)+"。":"confirm"===g?(e=n.getStats()).uploadFailNum&&(a="已成功上传"+e.successNum+"张照片至XX相册，"+e.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'):(e=n.getStats(),a="共"+f+"张（"+WebUploader.formatSize(m)+"），已上传"+e.successNum+"张",e.uploadFailNum&&(a+="，失败"+e.uploadFailNum+"张")),d.html(a)}function s(e){var a;if(e!==g){switch(c.removeClass("state-"+g),c.addClass("state-"+e),g=e){case"pedding":p.removeClass("element-invisible"),r.hide(),l.addClass("element-invisible"),n.refresh();break;case"ready":p.addClass("element-invisible"),$("#filePicker2").removeClass("element-invisible"),r.show(),l.removeClass("element-invisible"),n.refresh();break;case"uploading":$("#filePicker2").addClass("element-invisible"),u.show(),c.text("暂停上传");break;case"paused":u.show(),c.text("继续上传");break;case"confirm":if(u.hide(),$("#filePicker2").removeClass("element-invisible"),c.text("开始上传"),(a=n.getStats()).successNum&&!a.uploadFailNum)return void s("finish");break;case"finish":(a=n.getStats()).successNum?alert("上传成功"):(g="done",location.reload())}i()}}var n,o=$("#uploader"),r=$('<ul class="filelist"></ul>').appendTo(o.find(".queueList")),l=o.find(".statusBar"),d=l.find(".info"),c=o.find(".uploadBtn"),p=o.find(".placeholder"),u=l.find(".progress").hide(),f=0,m=0,h=window.devicePixelRatio||1,v=110*h,b=110*h,g="pedding",w={},k=function(){var e=new Image,a=!0;return e.onload=e.onerror=function(){1==this.width&&1==this.height||(a=!1)},e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a}(),x=function(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(a){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(a){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)}(),y=function(){var e=document.createElement("p").style,a="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,a}();WebUploader.Uploader.support("flash")||!WebUploader.browser.ie?WebUploader.Uploader.support()?((n=WebUploader.create({pick:{id:"#filePicker",label:"点击选择图片"},formData:{uid:123},dnd:"#dndArea",paste:"#uploader",swf:"./Uploader.swf",chunked:!1,chunkSize:524288,server:"http://localhost:8080/jiajiaobao/server/fileupload.php",disableGlobalDnd:!0,fileNumLimit:300,fileSizeLimit:209715200,fileSingleSizeLimit:52428800})).on("dndAccept",function(e){for(var a=!1,t=e.length,i=0;i<t;i++)if(~"text/plain;application/javascript ".indexOf(e[i].type)){a=!0;break}return!a}),n.on("dialogOpen",function(){console.log("here")}),n.addButton({id:"#filePicker2",label:"继续添加"}),n.on("ready",function(){window.uploader=n}),n.onUploadProgress=function(e,a){$("#"+e.id).find(".progress span").css("width",100*a+"%"),w[e.id][1]=a,t()},n.onFileQueued=function(a){f++,m+=a.size,1===f&&(p.addClass("element-invisible"),l.show()),e(a),s("ready"),t()},n.onFileDequeued=function(e){f--,m-=e.size,f||s("pedding"),a(e),t()},n.on("all",function(e){switch(e){case"uploadFinished":s("confirm");break;case"startUpload":s("uploading");break;case"stopUpload":s("paused")}}),n.onError=function(e){alert("Eroor: "+e)},c.on("click",function(){if($(this).hasClass("disabled"))return!1;"ready"===g?n.upload():"paused"===g?n.upload():"uploading"===g&&n.stop()}),d.on("click",".retry",function(){n.retry()}),d.on("click",".ignore",function(){alert("todo")}),c.addClass("state-"+g),t()):alert("Web Uploader 不支持您的浏览器！"):x?function(e){window.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete window.expressinstallcallback};var a="./expressInstall.swf",t='<object type="application/x-shockwave-flash" data="'+a+'" ';WebUploader.browser.ie&&(t+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),t+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+a+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',e.html(t)}(o):o.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')});