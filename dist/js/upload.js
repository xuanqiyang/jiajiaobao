!function(e){e(function(){function a(a){var t=e('<li id="'+a.id+'"><p class="title">'+a.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),i=e('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(t),s=t.find("p.progress span"),n=t.find("p.imgWrap"),r=e('<p class="error"></p>'),d=function(e){switch(e){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}r.text(text).appendTo(t)};"invalid"===a.getStatus()?d(a.statusText):(n.text("预览中"),o.makeThumb(a,function(a,t){var i;a?n.text("不能预览"):x?(i=e('<img src="'+t+'">'),n.empty().append(i)):e.ajax("../../server/preview.php",{method:"POST",data:t,dataType:"json"}).done(function(a){a.result?(i=e('<img src="'+a.result+'">'),n.empty().append(i)):n.text("预览出错")})},b,g),k[a.id]=[a.size,0],a.rotation=0),a.on("statuschange",function(e,n){"progress"===n?s.hide().width(0):"queued"===n&&(t.off("mouseenter mouseleave"),i.remove()),"error"===e||"invalid"===e?(console.log(a.statusText),d(a.statusText),k[a.id][1]=1):"interrupt"===e?d("interrupt"):"queued"===e?(r.remove(),s.css("display","block"),k[a.id][1]=0):"progress"===e?(r.remove(),s.css("display","block")):"complete"===e&&(s.hide().width(0),t.append('<span class="success"></span>')),t.removeClass("state-"+n).addClass("state-"+e)}),t.on("mouseenter",function(){i.stop().animate({height:30})}),t.on("mouseleave",function(){i.stop().animate({height:0})}),i.on("click","span",function(){var t;switch(e(this).index()){case 0:return void o.removeFile(a);case 1:a.rotation+=90;break;case 2:a.rotation-=90}A?(t="rotate("+a.rotation+"deg)",n.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})):n.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(a.rotation/90%4+4)%4+")")}),t.appendTo(l)}function t(a){var t=e("#"+a.id);delete k[a.id],i(),t.off().find(".file-panel").off().end().remove()}function i(){var a,t=0,i=0,n=f.children();e.each(k,function(e,a){i+=a[0],t+=a[0]*a[1]}),a=i?t/i:0,n.eq(0).text(Math.round(100*a)+"%"),n.eq(1).css("width",Math.round(100*a)+"%"),s()}function s(){var e,a="";"ready"===w?a="选中"+m+"张图片，共"+WebUploader.formatSize(h)+"。":"confirm"===w?(e=o.getStats()).uploadFailNum&&(a="已成功上传"+e.successNum+"张照片至XX相册，"+e.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'):(e=o.getStats(),a="共"+m+"张（"+WebUploader.formatSize(h)+"），已上传"+e.successNum+"张",e.uploadFailNum&&(a+="，失败"+e.uploadFailNum+"张")),c.html(a)}function n(a){var t;if(a!==w){switch(p.removeClass("state-"+w),p.addClass("state-"+a),w=a){case"pedding":u.removeClass("element-invisible"),l.hide(),d.addClass("element-invisible"),o.refresh();break;case"ready":u.addClass("element-invisible"),e("#filePicker2").removeClass("element-invisible"),l.show(),d.removeClass("element-invisible"),o.refresh();break;case"uploading":e("#filePicker2").addClass("element-invisible"),f.show(),p.text("暂停上传");break;case"paused":f.show(),p.text("继续上传");break;case"confirm":if(f.hide(),e("#filePicker2").removeClass("element-invisible"),p.text("开始上传"),(t=o.getStats()).successNum&&!t.uploadFailNum)return void n("finish");break;case"finish":(t=o.getStats()).successNum?alert("上传成功"):(w="done",location.reload())}s()}}var o,r=e("#uploader"),l=e('<ul class="filelist"></ul>').appendTo(r.find(".queueList")),d=r.find(".statusBar"),c=d.find(".info"),p=r.find(".uploadBtn"),u=r.find(".placeholder"),f=d.find(".progress").hide(),m=0,h=0,v=window.devicePixelRatio||1,b=110*v,g=110*v,w="pedding",k={},x=function(){var e=new Image,a=!0;return e.onload=e.onerror=function(){1==this.width&&1==this.height||(a=!1)},e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a}(),y=function(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(a){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(a){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)}(),A=function(){var e=document.createElement("p").style,a="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,a}();WebUploader.Uploader.support("flash")||!WebUploader.browser.ie?WebUploader.Uploader.support()?((o=WebUploader.create({pick:{id:"#filePicker",label:"点击选择图片"},formData:{uid:123},dnd:"#dndArea",paste:"#uploader",swf:"./Uploader.swf",chunked:!1,chunkSize:524288,server:"../../server/fileupload.php",disableGlobalDnd:!0,fileNumLimit:300,fileSizeLimit:209715200,fileSingleSizeLimit:52428800})).on("dndAccept",function(e){for(var a=!1,t=e.length,i=0;i<t;i++)if(~"text/plain;application/javascript ".indexOf(e[i].type)){a=!0;break}return!a}),o.on("dialogOpen",function(){console.log("here")}),o.addButton({id:"#filePicker2",label:"继续添加"}),o.on("ready",function(){window.uploader=o}),o.onUploadProgress=function(a,t){e("#"+a.id).find(".progress span").css("width",100*t+"%"),k[a.id][1]=t,i()},o.onFileQueued=function(e){m++,h+=e.size,1===m&&(u.addClass("element-invisible"),d.show()),a(e),n("ready"),i()},o.onFileDequeued=function(e){m--,h-=e.size,m||n("pedding"),t(e),i()},o.on("all",function(e){switch(e){case"uploadFinished":n("confirm");break;case"startUpload":n("uploading");break;case"stopUpload":n("paused")}}),o.onError=function(e){alert("Eroor: "+e)},p.on("click",function(){if(e(this).hasClass("disabled"))return!1;"ready"===w?o.upload():"paused"===w?o.upload():"uploading"===w&&o.stop()}),c.on("click",".retry",function(){o.retry()}),c.on("click",".ignore",function(){alert("todo")}),p.addClass("state-"+w),i()):alert("Web Uploader 不支持您的浏览器！"):y?function(e){window.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete window.expressinstallcallback};var a="./expressInstall.swf",t='<object type="application/x-shockwave-flash" data="'+a+'" ';WebUploader.browser.ie&&(t+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),t+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+a+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',e.html(t)}(r):r.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')})}(jQuery);