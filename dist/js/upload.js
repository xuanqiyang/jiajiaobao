define("upload",["jquery","webuploader"],function(e,a){function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function s(s,t){function n(a){var i=e("#"+a.id);delete T[a.id],d(),i.off().find(".file-panel").off().end().remove()}function o(a){var i=e('<li id="'+a.id+'"><p class="title">'+a.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),s=e('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(i),t=i.find("p.progress span"),n=i.find("p.imgWrap"),o=e('<p class="error"></p>'),d=function(e){switch(e){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}o.text(text).appendTo(i)};"invalid"===a.getStatus()?d(a.statusText):(n.text("预览中"),D.makeThumb(a,function(a,i){var s;a?n.text("不能预览"):N?(s=e('<img src="'+i+'">'),n.empty().append(s)):e.ajax("../../server/preview.php",{method:"POST",data:i,dataType:"json"}).done(function(a){a.result?(s=e('<img src="'+a.result+'">'),n.empty().append(s)):n.text("预览出错")})},C,F),T[a.id]=[a.size,0],a.rotation=0),a.on("statuschange",function(e,n){"progress"===n?t.hide().width(0):"queued"===n&&(i.off("mouseenter mouseleave"),s.remove()),"error"===e||"invalid"===e?(console.log(a.statusText),d(a.statusText),i.append(s),i.on("mouseenter",l),i.on("mouseleave",r),s.on("click","span",p),T[a.id][1]=1):"interrupt"===e?(d("interrupt"),i.append(s),i.on("mouseenter",l),i.on("mouseleave",r),s.on("click","span",p)):"queued"===e?(o.remove(),t.css("display","block"),T[a.id][1]=0):"progress"===e?(o.remove(),t.css("display","block")):"complete"===e&&(t.hide().width(0),i.append('<span class="success"></span>')),i.removeClass("state-"+n).addClass("state-"+e)});var l=function(){s.stop().animate({height:30})},r=function(){s.stop().animate({height:0})},p=function(){var i;switch(e(this).index()){case 0:return void D.removeFile(a);case 1:a.rotation+=90;break;case 2:a.rotation-=90}z?(i="rotate("+a.rotation+"deg)",n.css({"-webkit-transform":i,"-mos-transform":i,"-o-transform":i,transform:i})):n.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(a.rotation/90%4+4)%4+")")};i.on("mouseenter",l),i.on("mouseleave",r),s.on("click","span",p),i.appendTo(g)}function d(){var a,i=0,s=0,t=x.children();e.each(T,function(e,a){s+=a[0],i+=a[0]*a[1]}),a=s?i/s:0,t.eq(0).text(Math.round(100*a)+"%"),t.eq(1).css("width",Math.round(100*a)+"%"),l()}function l(){var e,i="";"ready"===I?i="选中"+y+"张图片，共"+a.formatSize(S)+"。":"confirm"===I?(e=D.getStats()).uploadFailNum&&(i="已成功上传"+e.successNum+"张照片至XX相册，"+e.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'):(e=D.getStats(),i="共"+y+"张（"+a.formatSize(S)+"），已上传"+e.successNum+"张",e.uploadFailNum&&(i+="，失败"+e.uploadFailNum+"张")),b.html(i)}function r(a){var i;if(a!==I){switch(j.removeClass("state-"+I),j.addClass("state-"+a),I=a){case"pedding":k.removeClass("element-invisible"),g.hide(),w.addClass("element-invisible"),D.refresh();break;case"ready":k.addClass("element-invisible"),e(".pickerid").removeClass("element-invisible"),g.show(),w.removeClass("element-invisible"),D.refresh();break;case"uploading":e(".pickerid").addClass("element-invisible"),x.show(),j.text("暂停上传");break;case"paused":x.show(),j.text("继续上传");break;case"confirm":if(x.hide(),e(".pickerid").removeClass("element-invisible"),j.text("开始上传"),(i=D.getStats()).successNum&&!i.uploadFailNum)return void r("finish");break;case"finish":(i=D.getStats()).successNum?alert("上传成功"):(I="done",location.reload())}l()}}if(!a.Uploader.support()){var p="上传控件不支持您的浏览器！请尝试升级flash版本或者使用Chrome引擎的浏览器。<a target='_blank' href='http://se.360.cn'>下载页面</a>";return window.console&&window.console.log(p),void e(s).text(p)}var c={auto:!0,hiddenInputId:"uploadifyHiddenInputId",onAllComplete:function(e){},onComplete:function(e){},innerOptions:{},fileNumLimit:void 0,fileSizeLimit:void 0,fileSingleSizeLimit:void 0,PostbackHold:!1},u=e.extend(c,t),f=e("#"+u.hiddenInputId),m=e(s),v="",h=m,g=e('<ul class="filelist"></ul>').appendTo(h.find(".queueList")),w=h.find(".statusBar"),b=w.find(".info"),k=h.find(".placeholder"),x=w.find(".progress").hide(),y=0,S=0,A=window.devicePixelRatio||1,C=110*A,F=110*A,I="pedding",T={},N=function(){var e=new Image,a=!0;return e.onload=e.onerror=function(){1==this.width&&1==this.height||(a=!1)},e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a}(),U=function(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(a){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(a){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)}(),z=function(){var e=document.createElement("p").style,a="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,a}();if(a.Uploader.support("flash")||!a.browser.ie)if(a.Uploader.support()){v="undefined"!=typeof guidGenerator36?guidGenerator36():(65536*(1+Math.random())|0).toString(16).substring(1);var L="";u.auto?L+='<div class="statusBar"><div class="progress"><span class="text">0%</span><span class="percentage"></span></div><div class="info"></div><div class="btns"><div class="'+v+'">选择文件</div>':L+='<div class="statusBar"><div class="progress"><span class="text">0%</span><span class="percentage"></span></div><div class="info"></div><div class="btns"><div class="'+v+'">选择文件</div><div class="uploadBtn">开始上传</div>',L+='<div style="display:none" class="UploadhiddenInput" >                         </div>',L+="</div>",m.append(L);var O=m.find(".uploader-list"),j=m.find(".uploadBtn"),I="pending",P=m.find(".UploadhiddenInput"),q={fileList:[]},B=e.extend({swf:"Uploader.swf",server:"http://webuploader.duapp.com/server/fileupload.php",pick:"."+v,resize:!1,fileNumLimit:u.fileNumLimit,fileSizeLimit:u.fileSizeLimit,fileSingleSizeLimit:u.fileSingleSizeLimit,accept:u.accept},u.innerOptions),D=a.create(B),M=f.val();M&&u.PostbackHold&&(q=JSON.parse(M),e.each(q.fileList,function(e,a){var s=i();a.queueId=s,O.append('<div id="'+s+'" class="item"><div class="info">'+a.name+'</div><div class="state">已上传</div><div class="del"></div></div>')}),f.val(JSON.stringify(q))),D.on("ready",function(){window.uploader=D}),j.on("click",function(){if(e(this).hasClass("disabled"))return!1;"ready"===I?D.upload():"paused"===I?D.upload():"uploading"===I&&D.stop()}),b.on("click",".retry",function(){D.retry()}),b.on("click",".ignore",function(){D.removeFile(file)}),j.addClass("state-"+I),d(),D.on("dialogOpen",function(){console.log("here")}),D.onUploadProgress=function(a,i){e("#"+a.id).find(".progress span").css("width",100*i+"%"),T[a.id][1]=i,d()},D.onFileQueued=function(e){y++,S+=e.size,1===y&&(k.addClass("element-invisible"),w.show()),o(e),r("ready"),d()},D.onFileDequeued=function(e){y--,S-=e.size,y||r("pedding"),n(e),d()},D.on("all",function(e){switch(e){case"uploadFinished":r("confirm");break;case"startUpload":r("uploading");break;case"stopUpload":r("paused")}}),D.onError=function(e){alert("Eroor: "+e)},D.on("uploadProgress",function(a,i){var t=m.find("#"+e(s)[0].id+a.id),n=t.find(".progress .bar");n.length||(n=e('<span class="progress"><span  class="percentage"><span class="text"></span><span class="bar" role="progressbar" style="width: 0%"></span></span></span>').appendTo(t).find(".bar")),t.find("span.webuploadstate").html("上传中"),t.find(".text").text(Math.round(100*i)+"%"),n.css("width",100*i+"%")}),D.on("uploadSuccess",function(a,i){"error"==i.state?m.find("#"+e(s)[0].id+a.id).find("span.webuploadstate").html(i.message):(m.find("#"+e(s)[0].id+a.id).find("span.webuploadstate").html("已上传"),P.append('<input type="text" id="hiddenInput'+e(s)[0].id+a.id+'" class="hiddenInput" value="'+i.message+'" />'))}),D.on("uploadError",function(a){m.find("#"+e(s)[0].id+a.id).find("span.webuploadstate").html("上传出错")}),D.on("uploadComplete",function(a){m.find("#"+e(s)[0].id+a.id).find(".progress").fadeOut()}),D.on("all",function(e){"startUpload"===e?I="uploading":"stopUpload"===e?I="paused":"uploadFinished"===e&&(I="done"),"uploading"===I?j.text("暂停上传"):j.text("开始上传")}),D.on("fileDequeued",function(a){var i=e("#hiddenInput"+e(s)[0].id+a.id).val();null!=i&&e.post(B.deleteServer,{fullName:i},function(e){alert(e.message)}),e("#"+e(s)[0].id+a.id).remove(),e("#hiddenInput"+e(s)[0].id+a.id).remove()}),O.on("click",".webuploadDelbtn",function(){alert("hi");var a=(a=e(this).parent().attr("id")).replace(e(s)[0].id,""),i=D.getFile(a);D.removeFile(i)})}else alert("Web Uploader 不支持您的浏览器！");else U?function(e){window.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete window.expressinstallcallback};var i="./expressInstall.swf",s='<object type="application/x-shockwave-flash" data="'+i+'" ';a.browser.ie&&(s+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),s+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+i+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',e.html(s)}(h):h.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}var t=""===window.applicationPath?"":window.applicationPath||"../..";e.fn.GetFilesAddress=function(a){var i=[];return e(this).find(".UploadhiddenInput").find(".hiddenInput").each(function(){i.push(e(this).val())}),i},e.fn.powerWebUpload=function(i){var n=this;if(void 0===a){var o=t+"/js/webuploader.css";e("<link>").attr({rel:"stylesheet",type:"text/css",href:o}).appendTo("head");var d=t+"/js/webuploader.js";e.getScript(d).done(function(){s(n,i)}).fail(function(){alert("请检查webuploader的路径是否正确!")})}else s(n,i)}});